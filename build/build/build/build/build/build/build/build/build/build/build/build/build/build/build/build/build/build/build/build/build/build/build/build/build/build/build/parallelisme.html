<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Saint-Clair, Tâm, José" />


<title>Optimisation de calcul scientifique via la parallélisation et la gestion de mémoire</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Finist'R 2021</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="https://github.com/StateOfTheR/finistR2021">
    <span class="fa fa-github"></span>
     
    
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="instructions.html">
    <span class="fa fa-gear"></span>
     
    Workflow
  </a>
</li>
<li>
  <a href="datavizu.html">
    <span class="fa fa-desktop"></span>
     
    Nouvelles Fonctions Graphiques
  </a>
</li>
<li>
  <a href="deepnote.html">
    <span class="fa fa-user-graduate"></span>
     
    Enseignement
  </a>
</li>
<li>
  <a href="webpages.html">
    <span class="fa fa-address-book-o"></span>
     
    Site Web
  </a>
</li>
<li>
  <a href="xarigan_flipbook.html">
    <span class="fa fa-slideshare"></span>
     
    Présentations
  </a>
</li>
<li>
  <a href="shiny.html">Shiny</a>
</li>
<li>
  <a href="test-unitaires.html">
    <span class="fa fa-box-open"></span>
     
    Package et tests
  </a>
</li>
<li>
  <a href="openmp.html">OpenMP</a>
</li>
<li>
  <a href="parallelisme.html">
    <span class="fa fa-box-open"></span>
     
    CalculMemoParal
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Optimisation de calcul scientifique via la parallélisation et la gestion de mémoire</h1>
<h4 class="author">Saint-Clair, Tâm, José</h4>
<h4 class="date">26/08/2021</h4>

</div>


<div id="un-benchmark" class="section level2">
<h2>Un benchmark</h2>
<p>Nous présentons des méthodes simples pour accélérer des gros calculs sous R en utilisant de la parallélisation. Afin d’évaluer différentes librairies de calcul, nous utilisons le script <a href="https://mac.r-project.org/benchmarks/">R-benchmark-25</a>.</p>
</div>
<div id="les-blas" class="section level2">
<h2>Les BLAS</h2>
<p>Un BLAS contient les routines de bas niveau permettant de réaliser les opérations basiques sur les vecteurs et les matrices (addition, produits scalaire et matriciel, etc.). Le BLAS de R natif est single-thread et des alternatives plus performantes existent telles que <a href="https://www.openblas.net">OpenBLAS</a> qui est multi-thread, <a href="http://math-atlas.sourceforge.net">ATLAS</a> qui s’adapte automatiquement à l’architecture locale de manière optimisée ou Intel MKL pour les processeurs Intel (aussi multi-thread).</p>
<p>Voici un tutoriel pour installer de nouvelles librairies BLAS/LAPACK optimisées sur les principaux système d’exploitations: [<a href="https://csantill.github.io/RPerformanceWBLAS/" class="uri">https://csantill.github.io/RPerformanceWBLAS/</a>]</p>
<p>Benchmark sur Intel® Core™ i5-8250U CPU @ 1.60GHz × 8 avec 8GO de RAM sous Ubuntu.</p>
<p>BLAS/LAPLACK</p>
<pre><code>Creation, transp., deformation of a 2500x2500 matrix (sec):  0.735666666666667 
2400x2400 normal distributed random matrix ^1000____ (sec):  0.54 
Sorting of 7,000,000 random values__________________ (sec):  0.772333333333333 
2800x2800 cross-product matrix (b = a&#39; * a)_________ (sec):  16.5476666666667 
Linear regr. over a 3000x3000 matrix (c = a \ b&#39;)___ (sec):  8.70833333333333 </code></pre>
<p>ATLAS</p>
<pre><code>Creation, transp., deformation of a 2500x2500 matrix (sec):  0.687 
2400x2400 normal distributed random matrix ^1000____ (sec):  0.530333333333333 
Sorting of 7,000,000 random values__________________ (sec):  0.762 
2800x2800 cross-product matrix (b = a&#39; * a)_________ (sec):  1.93433333333333 
Linear regr. over a 3000x3000 matrix (c = a \ b&#39;)___ (sec):  0.966666666666666 </code></pre>
<p>OpenBLAS (avec parallélisation)</p>
<pre><code>Creation, transp., deformation of a 2500x2500 matrix (sec):  0.709333333333333 
2400x2400 normal distributed random matrix ^1000____ (sec):  0.544666666666667 
Sorting of 7,000,000 random values__________________ (sec):  0.780666666666667 
2800x2800 cross-product matrix (b = a&#39; * a)_________ (sec):  0.835333333333333 
Linear regr. over a 3000x3000 matrix (c = a \ b&#39;)___ (sec):  0.274000000000001 </code></pre>
<p>Mais suivant la manière dont les différents package sont codés, les gains ne sont pas forcément évident. Voici un benchmark avec différents package d’analyse de réseaux: <code>sbm</code>, <code>missSBM</code>, <code>GREMLINS</code>:</p>
<p>BLAS/LAPLACK</p>
<pre><code>Data frenchblog2007 
==================== missSBM 1 core:  ==================
Time difference of 28.6378 secs
====================   sbm 1 core:  ==================
Time difference of 22.2913 secs
==================== missSBM 4 cores:  ==================
Time difference of 21.01817 secs
==================== sbm 4 cores:  ==================
Time difference of 17.59729 secs
Data MPEcoNetwork 
==================== Multipartite 1 core:  ==================
Time difference of 1.683621 mins
==================== Multipartite 4 cores:  ==================
Time difference of 1.008362 mins</code></pre>
<p>Atlas</p>
<pre><code>Data frenchblog2007 
==================== missSBM 1 core:  ==================
Time difference of 28.85101 secs
====================   sbm 1 core:  ==================
Time difference of 16.92881 secs
==================== missSBM 4 cores:  ==================
Time difference of 21.15375 secs
==================== sbm 4 cores:  ==================
Time difference of 13.93179 secs
Data MPEcoNetwork 
==================== Multipartite 1 core:  ==================
Time difference of 1.722041 mins
==================== Multipartite 4 cores:  ==================
Time difference of 56.11809 secs</code></pre>
<p>openBLAS</p>
<pre><code>Data frenchblog2007 
==================== missSBM 1 core:  ==================
Time difference of 1.282785 mins
====================   sbm 1 core:  ==================
Time difference of 17.01022 secs
==================== missSBM 4 cores:  ==================
Time difference of 1.094572 mins
==================== sbm 4 cores:  ==================
Time difference of 15.65691 secs
Data MPEcoNetwork 
==================== Multipartite 1 core:  ==================
Time difference of 1.66076 mins
==================== Multipartite 4 cores:  ==================
Time difference of 55.89039 secs</code></pre>
</div>
<div id="microsoft-r-open" class="section level2">
<h2>Microsoft R Open</h2>
<p><a href="https://mran.microsoft.com/download">Microsoft R Open</a> est une distribution améliorée de R conçue par Microsoft. Elle permet aussi d’utiliser facilement le BLAS d’Intel MKL avec R, ce qui accélère considérablement les calculs, notamment sous Windows (mais aussi sous Mac et Linux).</p>
<p>Voici les résultats du benchmark sur Intel(R) Core(TM) i3-7100U CPU @ 2.40GHz x 2 sous Windows 10 :</p>
<p>Sous R 4.1.1 et le BLAS natif :</p>
<pre><code>Creation, transp., deformation of a 2500x2500 matrix (sec):  0.913333333333333 
2400x2400 normal distributed random matrix ^1000____ (sec):  1.22333333333333 
Sorting of 7,000,000 random values__________________ (sec):  1.05 
2800x2800 cross-product matrix (b = a&#39; * a)_________ (sec):  20.0033333333333 
Linear regr. over a 3000x3000 matrix (c = a \ b&#39;)___ (sec):  9.58333333333333 </code></pre>
<p>Sous Microsoft R Open 4.0.2 et Intel MKL :</p>
<pre><code>Creation, transp., deformation of a 2500x2500 matrix (sec):  0.923333333333333 
2400x2400 normal distributed random matrix ^1000____ (sec):  1.16666666666667 
Sorting of 7,000,000 random values__________________ (sec):  1.04 
2800x2800 cross-product matrix (b = a&#39; * a)_________ (sec):  0.513333333333332 
Linear regr. over a 3000x3000 matrix (c = a \ b&#39;)___ (sec):  0.213333333333334 </code></pre>
<p>Un autre avantage de Microsoft R Open est la reproductibilité. En effet, chaque version de MROpen est associée à un snapshot du CRAN. Par exemple, la dernière version de MROpen est la 4.0.2 est fixée au 16/07/2020. Par conséquent, les packages qu’on essaie installer sous MROpen 4.0.2 sont récupérés dans leur état au 16/07/2020.</p>
</div>
<div id="tenter-de-comprendre-les-adresses-mémoires-pour-le-calcul-parallèle-multicoeur" class="section level2">
<h2>Tenter de comprendre les adresses mémoires pour le calcul parallèle multicoeur</h2>
<p>Sous Linux et MacOS, il est possible de paralléliser un code en faisant du multiprocess (en plus du multi-thread). Cela n’est pas possible sous Windows. Quelques librairies R pour le calcul parallèle : parallel, foreach, doParallel. Ici, on discute d’une curiosité rencontrée avec la fonction mclapply de la librairie parallel.</p>
<p>Les systèmes d’exploitation Linux et macOS ont un système de “shared memory” via POSIX qui évite de recopier certains objets. Toutefois il est difficile de complètement comprendre le comportement.</p>
<p>Just the tip what might have been going on R-devel Digest, Vol 149, Issue 22</p>
<p>Radford Neal’s answer from Jul 26, 2015:</p>
<p>“When mclapply forks to start a new process, the memory is initially shared with the parent process. However, a memory page has to be copied whenever either process writes to it. Unfortunately, R’s garbage collector writes to each object to mark and unmark it whenever a full garbage collection is done, so it’s quite possible that every R object will be duplicated in each process, even though many of them are not actually changed (from the point of view of the R programs).”</p>
<p>Voici un example:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lobstr)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bettermc)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;bettermc&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:parallel&#39;:
## 
##     mclapply</code></pre>
<p>Ici, on voit bien que la première case de la liste <code>B</code> pointe vers la case mémoire de la matrice <code>A</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e6</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">list</span>(A)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lobstr<span class="sc">::</span><span class="fu">obj_addr</span>(A))</span></code></pre></div>
<pre><code>## [1] &quot;0x7f6157ccd010&quot;</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lobstr<span class="sc">::</span><span class="fu">obj_addrs</span>(B))</span></code></pre></div>
<pre><code>## [1] &quot;0x7f6157ccd010&quot;</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lobstr<span class="sc">::</span><span class="fu">obj_sizes</span>(A, B))</span></code></pre></div>
<pre><code>## * 8,000,048 B
## *        56 B</code></pre>
<p>On a le même comportement avec un lapply:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>list_A <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="dv">10</span>),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    B[[<span class="dv">1</span>]]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lobstr<span class="sc">::</span><span class="fu">obj_addrs</span>(list_A))</span></code></pre></div>
<pre><code>##  [1] &quot;0x7f6157ccd010&quot; &quot;0x7f6157ccd010&quot; &quot;0x7f6157ccd010&quot; &quot;0x7f6157ccd010&quot;
##  [5] &quot;0x7f6157ccd010&quot; &quot;0x7f6157ccd010&quot; &quot;0x7f6157ccd010&quot; &quot;0x7f6157ccd010&quot;
##  [9] &quot;0x7f6157ccd010&quot; &quot;0x7f6157ccd010&quot;</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lobstr<span class="sc">::</span><span class="fu">obj_sizes</span>(A, list_A, B))</span></code></pre></div>
<pre><code>## * 8,000,048 B
## *       176 B
## *        56 B</code></pre>
<p>Par contre dès que l’on parallélise, on perd se comportement:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>list_A <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="dv">10</span>),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(B[[<span class="dv">1</span>]])</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">mc.cores =</span> 2L</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lobstr<span class="sc">::</span><span class="fu">obj_addrs</span>(list_A))</span></code></pre></div>
<pre><code>##  [1] &quot;0x7f6159d6c010&quot; &quot;0x7f6144a96010&quot; &quot;0x7f61595ca010&quot; &quot;0x7f61442f4010&quot;
##  [5] &quot;0x7f6154f05010&quot; &quot;0x7f613f85e010&quot; &quot;0x7f6154763010&quot; &quot;0x7f613f0bc010&quot;
##  [9] &quot;0x7f614785e010&quot; &quot;0x7f613e91a010&quot;</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lobstr<span class="sc">::</span><span class="fu">obj_sizes</span>(A, list_A, B))</span></code></pre></div>
<pre><code>## *  8,000,048 B
## * 80,000,656 B
## *         56 B</code></pre>
<p>L’objet semble être recopier lors du return:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>list_A <span class="ot">&lt;-</span> bettermc<span class="sc">::</span><span class="fu">mclapply</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="dv">10</span>),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span> (x) {</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    C <span class="ot">&lt;-</span> B[[<span class="dv">1</span>]] <span class="sc">+</span> x</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    lobstr<span class="sc">::</span><span class="fu">obj_addr</span>(C)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">mc.cores =</span> 2L</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">unlist</span>(list_A))</span></code></pre></div>
<pre><code>## [1] &quot;0x7f61470bc010&quot; &quot;0x7f614691a010&quot; &quot;0x7f6146178010&quot; &quot;0x7f61459d6010&quot;
## [5] &quot;0x7f613e178010&quot;</code></pre>
<p>Et le comportement semble différent suivant que l’on preschedule ou non :</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>list_A <span class="ot">&lt;-</span> bettermc<span class="sc">::</span><span class="fu">mclapply</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="dv">10</span>),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span> (x) {</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    C <span class="ot">&lt;-</span> B[[<span class="dv">1</span>]] <span class="sc">+</span> x</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    lobstr<span class="sc">::</span><span class="fu">obj_addr</span>(C)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">mc.cores =</span> 2L, <span class="at">mc.preschedule =</span> <span class="cn">FALSE</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">unlist</span>(list_A))</span></code></pre></div>
<pre><code>## [1] &quot;0x7f61470bc010&quot;</code></pre>
</div>
<div id="bettermc" class="section level2">
<h2>bettermc</h2>
<p>Le package bettermc [<a href="https://github.com/gfkse/bettermc" class="uri">https://github.com/gfkse/bettermc</a>] donne plus de controle sur le comportement, en donnant des options pour controler les retours des processus enfants en utilisant la “shared memory” POSIX.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(i) A</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">bettermc1 =</span> bettermc<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, f, <span class="at">mc.share.copy =</span> <span class="cn">FALSE</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">bettermc2 =</span> bettermc<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, f),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bettermc3 =</span> bettermc<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, f, <span class="at">mc.share.vectors =</span> <span class="cn">FALSE</span>),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">bettermc4 =</span> bettermc<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, f, <span class="at">mc.share.vectors =</span> <span class="cn">FALSE</span>, <span class="at">mc.shm.ipc =</span> <span class="cn">FALSE</span>),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel =</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, f),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span>, <span class="at">setup =</span> <span class="fu">gc</span>()</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Unit: milliseconds
##       expr     min      lq     mean   median      uq     max neval
##  bettermc1 21.0391 21.9447 23.58382 23.52095 24.7344 27.5487    10
##  bettermc2 31.2834 32.3239 33.34185 33.01040 33.5171 37.4371    10
##  bettermc3 44.8864 46.0410 50.78218 51.07525 54.8685 56.4466    10
##  bettermc4 43.7268 44.9101 45.88531 45.62115 47.5335 47.7850    10
##   parallel 37.7519 39.5117 41.93564 41.53135 44.7038 47.6537    10</code></pre>
<p>Le package permet également de faire des parallélisation reproductible et donne beaucoup plus de controle sur la gestion des erreurs en permettant entre autre de relancer les processus qui ont renvoyé des erreurs.</p>
<p>L’extention bettermcExt [<a href="https://github.com/gfkse/bettermcExt" class="uri">https://github.com/gfkse/bettermcExt</a>] non autorisé sur le <code>CRAN</code> permet d’overloader la fonction <code>mclapply</code> de <code>parallel</code> d’un package donné, permettant ainsi un gain de temps et de rendre les calculs reproductibles.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
